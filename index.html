<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Meet: Ultra HD Cinema</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500&display=swap');
        
        body {
            font-family: 'Google Sans', 'Roboto', sans-serif;
            background-color: #202124; /* Google Meet Background */
            color: #e8eaed;
            overflow: hidden;
        }

        /* Utils */
        .icon-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .icon-btn:hover {
            background-color: rgba(232, 234, 237, 0.1);
        }
        .icon-btn.active {
            background-color: #ea4335; /* Google Red */
            color: white;
            border-color: transparent;
        }
        .icon-btn.active:hover {
            background-color: #d93025;
        }
        
        /* Video Elements */
        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 12px;
        }
        
        .pip-container {
            position: absolute;
            bottom: 24px;
            right: 24px;
            width: 280px;
            height: 160px;
            background: #3c4043;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 2px 6px 2px rgba(60,64,67,0.15);
            transition: all 0.3s ease;
            z-index: 50;
        }
        
        .pip-container video {
            object-fit: cover;
            transform: scaleX(-1); /* Mirror effect for self */
        }

        .main-stage {
            height: calc(100vh - 80px); /* Subtract footer height */
            padding: 16px;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .main-video-wrapper {
            width: 100%;
            height: 100%;
            background: #000; /* Black bars for cinema */
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* UI Overlays */
        .badge {
            position: absolute;
            bottom: 12px;
            left: 12px;
            background: rgba(0,0,0,0.6);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            color: white;
            pointer-events: none;
        }

        .loading-pulse {
            animation: pulse-ring 2s infinite;
        }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(26, 115, 232, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(26, 115, 232, 0); }
            100% { box-shadow: 0 0 0 0 rgba(26, 115, 232, 0); }
        }

        /* Modal */
        .meet-modal {
            background: #ffffff;
            color: #202124;
            border-radius: 28px; /* Material 3 style */
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Pre-call / Lobby -->
    <div id="lobby" class="absolute inset-0 z-50 bg-[#202124] flex items-center justify-center">
        <div class="flex flex-col md:flex-row max-w-5xl w-full p-8 items-center gap-12">
            
            <!-- Left: Hero Text -->
            <div class="flex-1 space-y-6">
                <h1 class="text-4xl md:text-5xl font-normal leading-tight text-white">
                    Видеовстречи премиум-качества. <br>
                    <span class="text-[#8ab4f8]">Бесплатно для всех.</span>
                </h1>
                <p class="text-[#9aa0a6] text-lg">
                    Мы используем P2P ускоритель для достижения 1080p/60fps. Идеально для совместного просмотра кино.
                </p>
                
                <div class="flex flex-col gap-4 mt-8">
                    <div class="flex items-center gap-3">
                        <button onclick="createRoom()" class="bg-[#1a73e8] hover:bg-[#1967d2] text-white px-6 py-3 rounded-md font-medium flex items-center gap-2 transition-colors shadow-lg">
                            <span class="material-icons-round text-xl">video_call</span>
                            Новая встреча
                        </button>
                        
                        <div class="relative flex-1 max-w-xs">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="material-icons-round text-gray-500">keyboard</span>
                            </div>
                            <input type="text" id="joinIdInput" placeholder="Введите код или ссылку" 
                                class="w-full bg-transparent border border-[#5f6368] text-white rounded-md py-3 pl-10 pr-4 focus:outline-none focus:border-[#8ab4f8] focus:ring-1 focus:ring-[#8ab4f8] transition-all">
                        </div>
                        <button onclick="joinRoom()" class="text-[#8ab4f8] font-medium hover:bg-[#202124] px-4 py-3 rounded hover:bg-[#303134] transition-colors">
                            Присоединиться
                        </button>
                    </div>
                </div>

                <div id="statusMsg" class="h-6 text-[#1a73e8] text-sm font-medium"></div>
            </div>

            <!-- Right: Preview -->
            <div class="relative w-full max-w-md aspect-video bg-[#3c4043] rounded-2xl overflow-hidden shadow-2xl border border-[#5f6368]">
                <video id="previewVideo" autoplay muted playsinline class="w-full h-full object-cover transform -scale-x-100"></video>
                <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-4">
                    <button onclick="togglePreviewAudio()" id="prevAudioBtn" class="w-12 h-12 rounded-full border border-[#5f6368] bg-[#3c4043] flex items-center justify-center hover:bg-[#45484c] text-white transition-colors">
                        <span class="material-icons-round text-xl">mic</span>
                    </button>
                    <button onclick="togglePreviewVideo()" id="prevVideoBtn" class="w-12 h-12 rounded-full border border-[#5f6368] bg-[#3c4043] flex items-center justify-center hover:bg-[#45484c] text-white transition-colors">
                        <span class="material-icons-round text-xl">videocam</span>
                    </button>
                </div>
                <div class="absolute top-4 left-4 bg-black/50 px-3 py-1 rounded-full text-xs font-medium">Предпросмотр</div>
            </div>
        </div>
    </div>

    <!-- Active Call Interface -->
    <div id="callInterface" class="hidden flex-col h-full w-full relative">
        
        <!-- Main Stage (Remote Video) -->
        <div class="main-stage">
            <div class="main-video-wrapper group">
                <!-- Waiting State -->
                <div id="waitingUi" class="absolute inset-0 flex flex-col items-center justify-center text-[#9aa0a6] z-10">
                    <div class="w-24 h-24 rounded-full bg-[#3c4043] flex items-center justify-center mb-4 loading-pulse">
                        <span class="material-icons-round text-4xl">person_outline</span>
                    </div>
                    <p class="text-xl">Ожидание собеседника...</p>
                    <p class="text-sm mt-2 font-mono bg-[#3c4043] px-3 py-1 rounded select-all cursor-pointer" onclick="copyId()" id="roomIdDisplay">Загрузка ID...</p>
                    <p class="text-xs mt-2 text-[#5f6368]">Нажмите на код, чтобы скопировать</p>
                </div>

                <video id="remoteVideo" autoplay playsinline class="relative z-20"></video>
                <div class="badge z-30 group-hover:opacity-100 transition-opacity" id="remoteBadge">Собеседник</div>
            </div>
        </div>

        <!-- Self View (PIP) -->
        <div class="pip-container" id="localPip">
            <video id="localVideoCall" autoplay muted playsinline></video>
            <div class="absolute bottom-2 left-2 bg-black/50 px-2 py-0.5 rounded text-[10px] text-white font-medium">Вы</div>
        </div>

        <!-- Bottom Control Bar -->
        <div class="h-20 bg-[#202124] flex items-center justify-between px-6 shrink-0 relative z-50">
            <!-- Left Info -->
            <div class="flex items-center gap-4 min-w-[200px]">
                <div class="text-white font-medium text-lg" id="clock">12:00</div>
                <div class="w-px h-6 bg-[#5f6368]"></div>
                <div class="text-[#e8eaed] text-sm font-medium truncate max-w-[150px]" id="codeDisplay">code-here</div>
            </div>

            <!-- Center Controls -->
            <div class="flex items-center gap-3">
                <!-- Mic -->
                <button onclick="toggleCallAudio()" id="callMicBtn" class="icon-btn w-12 h-12 rounded-full bg-[#3c4043] text-white border border-[#5f6368] flex items-center justify-center hover:bg-[#484c50]" title="Микрофон">
                    <span class="material-icons-round text-xl">mic</span>
                </button>

                <!-- Camera -->
                <button onclick="toggleCallVideo()" id="callCamBtn" class="icon-btn w-12 h-12 rounded-full bg-[#3c4043] text-white border border-[#5f6368] flex items-center justify-center hover:bg-[#484c50]" title="Камера">
                    <span class="material-icons-round text-xl">videocam</span>
                </button>

                <!-- Screen Share (Hero Feature) -->
                <button onclick="toggleScreenShare()" id="shareBtn" class="icon-btn w-12 h-12 rounded-full bg-[#3c4043] text-white border border-[#5f6368] flex items-center justify-center hover:bg-[#484c50] ml-2" title="Трансляция экрана (HQ)">
                    <span class="material-icons-round text-xl">present_to_all</span>
                </button>

                <!-- End Call -->
                <button onclick="hangUp()" class="w-16 h-10 rounded-full bg-[#ea4335] text-white flex items-center justify-center hover:bg-[#d93025] ml-4 transition-colors">
                    <span class="material-icons-round text-xl">call_end</span>
                </button>
            </div>

            <!-- Right Info -->
            <div class="flex items-center gap-4 justify-end min-w-[200px]">
                 <button class="text-[#e8eaed] hover:bg-[#3c4043] p-2 rounded-full">
                    <span class="material-icons-round text-xl">info_outline</span>
                 </button>
                 <button class="text-[#e8eaed] hover:bg-[#3c4043] p-2 rounded-full">
                    <span class="material-icons-round text-xl">people_outline</span>
                 </button>
            </div>
        </div>
    </div>

    <script>
        // --- High Performance Config ---
        // Force high bitrate SDP to prevent blurry video
        const BANDWIDTH_LIMIT = 6000; // 6 Mbps

        function hackSDP(sdp) {
            // This function modifies the SDP text to force higher bitrates
            let allowed = sdp;
            if (allowed.includes("b=AS:")) {
                // If bitrate line exists, replace it
                allowed = allowed.replace(/b=AS:([0-9]+)/g, `b=AS:${BANDWIDTH_LIMIT}`);
            } else {
                // If not, add it for video
                allowed = allowed.replace(/a=mid:video\r\n/g, `a=mid:video\r\nb=AS:${BANDWIDTH_LIMIT}\r\n`);
            }
            return allowed;
        }

        // --- State ---
        let peer = null;
        let myId = null;
        let conn = null; // Data connection (optional)
        let call = null; // Media connection
        let localStream = null;
        let screenStream = null;
        let isSharing = false;

        // --- Elements ---
        const ui = {
            lobby: document.getElementById('lobby'),
            callInterface: document.getElementById('callInterface'),
            previewVideo: document.getElementById('previewVideo'),
            localVideoCall: document.getElementById('localVideoCall'),
            remoteVideo: document.getElementById('remoteVideo'),
            joinInput: document.getElementById('joinIdInput'),
            roomIdDisplay: document.getElementById('roomIdDisplay'),
            codeDisplay: document.getElementById('codeDisplay'),
            statusMsg: document.getElementById('statusMsg'),
            waitingUi: document.getElementById('waitingUi'),
            remoteBadge: document.getElementById('remoteBadge'),
            btns: {
                prevMic: document.getElementById('prevAudioBtn'),
                prevCam: document.getElementById('prevVideoBtn'),
                callMic: document.getElementById('callMicBtn'),
                callCam: document.getElementById('callCamBtn'),
                share: document.getElementById('shareBtn')
            }
        };

        // --- Initialization ---
        async function init() {
            updateClock();
            setInterval(updateClock, 1000);
            
            // Get initial stream
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720 }, // Good web cam quality
                    audio: { echoCancellation: true, noiseSuppression: true }
                });
                
                ui.previewVideo.srcObject = localStream;
                ui.localVideoCall.srcObject = localStream; // Ready for call
                
            } catch (e) {
                console.error("Media Error:", e);
                alert("Нет доступа к камере/микрофону. Проверьте разрешения браузера.");
            }

            // Init PeerJS
            peer = new Peer(null, { debug: 1 });
            
            peer.on('open', (id) => {
                myId = id;
                console.log("My ID:", id);
            });

            peer.on('call', (incomingCall) => {
                if(confirm("Входящий звонок. Принять?")) {
                    enterCallMode();
                    // Answer the call, providing our mediaStream
                    incomingCall.answer(localStream);
                    handleCallStream(incomingCall);
                }
            });

            peer.on('error', (err) => {
                ui.statusMsg.innerText = "Ошибка: " + err.type;
                ui.statusMsg.classList.add('text-red-500');
            });
        }

        // --- Core Calling Logic ---

        function createRoom() {
            if(!myId) return alert("Инициализация сети... подождите пару секунд");
            enterCallMode();
            ui.roomIdDisplay.innerText = myId;
            ui.codeDisplay.innerText = myId;
            // Wait for incoming call logic handled in init()
        }

        function joinRoom() {
            const destId = ui.joinInput.value.trim();
            if(!destId) return alert("Введите ID");
            
            enterCallMode();
            ui.roomIdDisplay.innerText = "Подключение...";
            ui.codeDisplay.innerText = destId;

            // Call peer
            // NOTE: We do NOT modify SDP here directly in PeerJS easily, 
            // but we ensure we send high quality stream request later
            const outgoingCall = peer.call(destId, localStream);
            handleCallStream(outgoingCall);
        }

        function handleCallStream(currentCall) {
            call = currentCall;

            // Wait for stream
            call.on('stream', (remoteStream) => {
                console.log("Stream received");
                ui.waitingUi.classList.add('hidden'); // Hide waiting text
                ui.remoteVideo.srcObject = remoteStream;
            });

            // Handle errors/close
            call.on('close', () => hangUp());
            call.on('error', () => hangUp());
            
            // Attempt to hack SDP for bitrate when negotiating
            // PeerJS hides the RTCPeerConnection, but we can access it via call.peerConnection
            const pc = call.peerConnection;
            
            // Modern WebRTC bitrate forcing is complex, often requires "mangling" SDP 
            // before settingLocalDescription. PeerJS handles this internally.
            // However, we can use RTCRtpSender.setParameters if supported to set maxBitrate dynamically
            
            // Try to boost bandwidth every 2 seconds
            setInterval(() => {
                if(pc && pc.getSenders) {
                    pc.getSenders().forEach(sender => {
                        if(sender.track && sender.track.kind === 'video') {
                            const params = sender.getParameters();
                            if(!params.encodings) params.encodings = [{}];
                            // Force 6mbps
                            params.encodings[0].maxBitrate = 6000000; 
                            sender.setParameters(params).catch(e => {}); 
                        }
                    });
                }
            }, 2000);
        }

        function enterCallMode() {
            ui.lobby.classList.add('hidden');
            ui.callInterface.classList.remove('hidden');
            ui.callInterface.classList.add('flex');
        }

        function hangUp() {
            if(call) call.close();
            if(isSharing) stopSharing();
            location.reload(); // Simple reset
        }

        // --- Media Control (The Fix) ---

        function toggleTrack(kind, btnId, iconOn, iconOff) {
            if(!localStream) return;
            const track = kind === 'video' ? localStream.getVideoTracks()[0] : localStream.getAudioTracks()[0];
            
            if(track) {
                track.enabled = !track.enabled;
                const btn = document.getElementById(btnId);
                const isActive = !track.enabled; // If disabled, button is "Active" (Red)
                
                if(isActive) {
                    btn.classList.add('active');
                    btn.querySelector('span').innerText = iconOff;
                } else {
                    btn.classList.remove('active');
                    btn.querySelector('span').innerText = iconOn;
                }
            }
        }

        // Preview Toggles
        window.togglePreviewAudio = () => toggleTrack('audio', 'prevAudioBtn', 'mic', 'mic_off');
        window.togglePreviewVideo = () => toggleTrack('video', 'prevVideoBtn', 'videocam', 'videocam_off');
        
        // Call Toggles
        window.toggleCallAudio = () => toggleTrack('audio', 'callMicBtn', 'mic', 'mic_off');
        window.toggleCallVideo = () => toggleTrack('video', 'callCamBtn', 'videocam', 'videocam_off');

        // --- Screen Share Logic (Nitro Quality) ---

        async function toggleScreenShare() {
            if(!call) return alert("Сначала начните звонок");
            
            if(isSharing) {
                stopSharing();
                return;
            }

            try {
                // FORCE 1080p 60FPS constraints
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        width: { ideal: 1920, max: 2560 }, // Ask for 2K, settle for 1080p
                        height: { ideal: 1080, max: 1440 },
                        frameRate: { ideal: 60, min: 30 }, // Force high framerate
                        displaySurface: "browser", // Hint to browser
                        cursor: "always"
                    },
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false,
                        channelCount: 2 // Stereo sound
                    }
                });

                const videoTrack = screenStream.getVideoTracks()[0];
                const audioTrack = screenStream.getAudioTracks()[0];

                // Handle User clicking "Stop sharing" in browser UI
                videoTrack.onended = () => stopSharing();

                const sender = call.peerConnection.getSenders().find(s => s.track.kind === 'video');
                if(sender) {
                    await sender.replaceTrack(videoTrack);
                }

                // If audio exists, try to replace/add
                if(audioTrack) {
                    const audioSender = call.peerConnection.getSenders().find(s => s.track.kind === 'audio');
                     if(audioSender) {
                        await audioSender.replaceTrack(audioTrack);
                     }
                }

                // UI Updates
                ui.localVideoCall.srcObject = screenStream; // Show what we share in PIP
                ui.btns.share.classList.add('text-[#8ab4f8]', 'bg-[#1a73e8]', 'bg-opacity-20'); // Highlight button
                isSharing = true;

            } catch(e) {
                console.error("Share failed", e);
            }
        }

        async function stopSharing() {
            if(!screenStream) return;
            
            screenStream.getTracks().forEach(t => t.stop());
            
            // Revert tracks to Webcam
            const videoTrack = localStream.getVideoTracks()[0];
            const audioTrack = localStream.getAudioTracks()[0];
            
            const sender = call.peerConnection.getSenders().find(s => s.track.kind === 'video');
            const audioSender = call.peerConnection.getSenders().find(s => s.track.kind === 'audio');
            
            if(sender) await sender.replaceTrack(videoTrack);
            if(audioSender) await audioSender.replaceTrack(audioTrack);

            ui.localVideoCall.srcObject = localStream;
            ui.btns.share.classList.remove('text-[#8ab4f8]', 'bg-[#1a73e8]', 'bg-opacity-20');
            isSharing = false;
            screenStream = null;
        }

        // --- Helpers ---
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = 
                now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        }

        window.copyId = () => {
            navigator.clipboard.writeText(myId);
            alert("ID скопирован");
        };

        // Run
        init();

    </script>
</body>
</html>
